<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatzi - Chat</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="fullChatPage">
  <!-- Top bar -->
  <div class="topbar">
    <div class="topLeft">
      <div class="logoDot">ğŸ’¬</div>
      <div>Chatzi</div>
    </div>

    <div class="handleRow">
      <span id="handle">@anonymous</span>
      <span class="greenDot" title="Online"></span>
    </div>

    <div class="topRight">
      <span class="badge">Press <b>Esc</b> to skip</span>
      <button class="iconBtn" id="bellBtn" title="Notifications">ğŸ””</button>
      <button class="iconBtn" id="helpBtn" title="Safety">ğŸ›¡ï¸</button>
    </div>
  </div>

  <div class="chatWrap">
    <!-- Center info -->
    <div class="centerInfo">
      <div class="infoCard">
        <div class="infoTitle">âœ¨ Send messages to your stranger âœ¨</div>
        Share thoughts, feelings & experiences. Be kind ğŸ¤ â€¢ No scams ğŸš« â€¢ Stay safe âœ…
      </div>
    </div>

    <!-- Banner for "left the chat" -->
    <div class="banner" id="leftBanner">
      <div>
        <span id="leftName">Stranger</span> left the chat
        <div class="small">Donâ€™t wait! Find someone better right now.</div>
      </div>
      <button class="pill" id="bannerNewChat">Find Match Now</button>
    </div>

    <!-- Messages -->
    <div id="messages" class="chatArea"></div>

    <!-- Typing -->
    <div class="typingRow" id="typingRow" style="display:none;">
      <span class="typingDot"></span><span class="typingDot"></span><span class="typingDot"></span>
      <span id="typingText">Stranger is typingâ€¦</span>
    </div>

    <!-- Starters -->
    <div class="startersWrap">
      <div class="starters" id="starters">
        <button class="chip">ğŸŒ Where are you from?</button>
        <button class="chip">ğŸ¿ What brings you here today?</button>
        <button class="chip">ğŸ‘€ What are you looking for?</button>
        <button class="chip">ğŸµ What music are you into?</button>
        <button class="chip">âœ¨ Tell me something cool about you</button>
      </div>
    </div>

    <!-- Input bar -->
    <div class="inputBar">
      <div class="inputInner">
        <button class="roundBtn" id="gifBtn" title="Send a GIF">GIF</button>
        <input id="msgInput" class="msgInput" placeholder="Message..." autocomplete="off" />
        <button id="sendBtn" class="sendBtn" disabled>Send</button>
        <button id="nextBtn" class="newBtn">New Chat</button>
      </div>
    </div>
  </div>

  <!-- GIF picker -->
  <div class="gifPanel" id="gifPanel">
    <div class="gifHeader">
      <span>Pick a GIF</span>
      <button class="iconBtn" id="gifClose" title="Close">âœ•</button>
    </div>
    <div class="gifGrid" id="gifGrid"></div>
  </div>

  <!-- Modal overlay: Finding match -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalTop">
        <div>Start New Chat</div>
        <button class="iconBtn" id="modalClose" title="Close">âœ•</button>
      </div>
      <div class="modalSub">Finding your matchâ€¦ please wait while we connect you.</div>

      <div class="progressBar"><div class="progressFill"></div></div>

      <div class="modalBox" id="modalHint">
        ğŸ”’ Tip: You can add filters later. For now, instant matching is enabled.
      </div>

      <div class="modalActions">
        <button class="modalPrimary" id="modalPrimary">Findingâ€¦</button>
        <button class="modalGhost" id="modalCancel">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ===================== Config ===================== */
const BACKEND = "https://chatzi-backend.onrender.com";

/* ===================== Params ===================== */
const params = new URLSearchParams(window.location.search);
const myName = params.get("name") || ("User" + Math.floor(Math.random()*9000));
const myGender = params.get("gender") || "Other";

/* ===================== UI refs ===================== */
const handleEl = document.getElementById("handle");
const messagesEl = document.getElementById("messages");
const inputEl = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const nextBtn = document.getElementById("nextBtn");

const typingRow = document.getElementById("typingRow");
const leftBanner = document.getElementById("leftBanner");
const leftNameEl = document.getElementById("leftName");
const bannerNewChat = document.getElementById("bannerNewChat");

const overlay = document.getElementById("overlay");
const modalClose = document.getElementById("modalClose");
const modalCancel = document.getElementById("modalCancel");
const modalPrimary = document.getElementById("modalPrimary");

/* GIF UI */
const gifBtn = document.getElementById("gifBtn");
const gifPanel = document.getElementById("gifPanel");
const gifClose = document.getElementById("gifClose");
const gifGrid = document.getElementById("gifGrid");

/* ===================== State ===================== */
let socket = null;
let currentRoom = null;
let partnerGender = null;
let typingTimeout = null;
let iAmTyping = false;

/* ===================== Helpers ===================== */
handleEl.textContent = "@"+myName.toLowerCase().replace(/[^a-z0-9_]/g,"_");

function showTyping(show){
  typingRow.style.display = show ? "flex" : "none";
  if(show) messagesEl.scrollTop = messagesEl.scrollHeight;
}

function showBannerLeft(show, who="Stranger"){
  leftBanner.style.display = show ? "flex" : "none";
  leftNameEl.textContent = who;
}

function openModal(){
  overlay.style.display = "flex";
  modalPrimary.textContent = "Findingâ€¦";
  modalPrimary.disabled = true;
}
function closeModal(){
  overlay.style.display = "none";
}

function openGif(){
  gifPanel.style.display = "block";
}
function closeGif(){
  gifPanel.style.display = "none";
}

function isImageUrl(s){
  return /^https?:\/\/\S+\.(png|jpe?g|gif|webp)(\?\S*)?$/i.test(s.trim());
}

function addBubble(text, who="system"){
  const row = document.createElement("div");
  row.className = "msgRow " + who;

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  if(isImageUrl(text)){
    const img = document.createElement("img");
    img.src = text.trim();
    img.alt = "media";
    bubble.appendChild(img);
  }else{
    bubble.textContent = text;
  }

  row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function timeoutFetch(url, ms){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), ms);
  return fetch(url, { signal: controller.signal, cache: "no-store" })
    .finally(() => clearTimeout(t));
}

function loadSocketIoCdn(){
  return new Promise((resolve, reject) => {
    const s = document.createElement("script");
    s.src = "https://cdn.socket.io/4.7.5/socket.io.min.js";
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function wakeServer(){
  // quick wake check
  try{
    const res = await timeoutFetch(BACKEND + "/health", 12000);
    return res.ok;
  }catch{
    return false;
  }
}

/* ===================== Matching UX ===================== */
async function startNewMatch(){
  showBannerLeft(false);
  showTyping(false);
  messagesEl.innerHTML = "";
  currentRoom = null;
  sendBtn.disabled = true;

  openModal();

  const ok = await wakeServer();
  if(!ok){
    addBubble("âš ï¸ Server is waking up (free hosting). Try again in a few seconds.", "system");
    modalPrimary.textContent = "Try again";
    modalPrimary.disabled = false;
    modalPrimary.onclick = () => startNewMatch();
    return;
  }

  // ensure socket connected
  if(!socket){
    await connectSocket();
  }else if(socket.disconnected){
    socket.connect();
  }

  // ask for match
  socket.emit("find_match");
  modalPrimary.textContent = "Findingâ€¦";
  modalPrimary.disabled = true;
}

function finishModal(){
  closeModal();
}

/* ===================== Socket ===================== */
async function connectSocket(){
  await loadSocketIoCdn();

  socket = io(BACKEND, {
    transports: ["polling"],   // stable on Render free
    upgrade: false,
    timeout: 60000
  });

  socket.on("connect", () => {
    socket.emit("register_profile", { name: myName, gender: myGender });
  });

  socket.on("waiting", () => {
    // keep modal open while waiting
  });

  socket.on("matched", ({ room, partner }) => {
    currentRoom = room;
    partnerGender = partner?.gender || "Stranger";
    finishModal();
    sendBtn.disabled = false;

    addBubble("âœ… Connected. Be kind. No personal info. Stay safe âœ…", "system");
    addBubble(`You are chatting with: ${partnerGender}`, "system");
    inputEl.focus();
  });

  socket.on("receive_message", (msg) => {
    showTyping(false);
    addBubble(msg, "them");
  });

  socket.on("partner_left", () => {
    showTyping(false);
    sendBtn.disabled = true;
    showBannerLeft(true, partnerGender || "Stranger");
    addBubble("âš ï¸ Stranger left the chat.", "system");
  });

  socket.on("typing", () => {
    showTyping(true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => showTyping(false), 1200);
  });

  socket.on("connect_error", () => {
    showTyping(false);
    addBubble("âš ï¸ Connection problem. Press New Chat to retry.", "system");
  });
}

/* ===================== Sending ===================== */
function sendNow(textOverride=null){
  const msg = (textOverride ?? inputEl.value).trim();
  if(!msg || !currentRoom || !socket || socket.disconnected) return;

  addBubble(msg, "me");
  socket.emit("send_message", { room: currentRoom, message: msg });

  inputEl.value = "";
  iAmTyping = false;
}

sendBtn.onclick = () => sendNow();
inputEl.addEventListener("keydown", (e) => {
  if(e.key === "Enter") sendNow();
});

inputEl.addEventListener("input", () => {
  if(!socket || socket.disconnected || !currentRoom) return;

  if(!iAmTyping){
    iAmTyping = true;
    socket.emit("typing", { room: currentRoom });
    setTimeout(() => { iAmTyping = false; }, 700);
  }
});

/* ESC skip */
document.addEventListener("keydown", (e) => {
  if(e.key === "Escape") startNewMatch();
});

/* New chat button */
nextBtn.onclick = startNewMatch;
bannerNewChat.onclick = startNewMatch;

/* Modal buttons */
modalClose.onclick = closeModal;
modalCancel.onclick = closeModal;

/* Conversation starter chips */
document.getElementById("starters").addEventListener("click", (e) => {
  const btn = e.target.closest(".chip");
  if(!btn) return;
  // yapping shows as suggestions; we auto-fill (not auto-send)
  inputEl.value = btn.textContent.replace(/^\S+\s/, ""); // remove emoji space
  inputEl.focus();
});

/* ===================== GIF picker (no API key, curated) ===================== */
const GIFS = [
  { title:"Hi", url:"https://media.giphy.com/media/ASd0Ukj0y3qMM/giphy.gif" },
  { title:"LOL", url:"https://media.giphy.com/media/10JhviFuU2gWD6/giphy.gif" },
  { title:"Wow", url:"https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif" },
  { title:"Nice", url:"https://media.giphy.com/media/111ebonMs90YLu/giphy.gif" },
  { title:"Ok", url:"https://media.giphy.com/media/3o6Zt481isNVuQI1l6/giphy.gif" },
  { title:"Bye", url:"https://media.giphy.com/media/5xtDarEgBDjEoWo6VRS/giphy.gif" },
  { title:"Cute", url:"https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" },
  { title:"Dance", url:"https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif" },
];

function renderGifs(){
  gifGrid.innerHTML = "";
  GIFS.forEach(g => {
    const card = document.createElement("div");
    card.className = "gifItem";
    card.title = g.title;
    const img = document.createElement("img");
    img.src = g.url;
    img.alt = g.title;
    card.appendChild(img);
    card.onclick = () => {
      closeGif();
      sendNow(g.url);
    };
    gifGrid.appendChild(card);
  });
}
renderGifs();

gifBtn.onclick = () => {
  if(gifPanel.style.display === "block") closeGif();
  else openGif();
};
gifClose.onclick = closeGif;

// close gif if click outside
document.addEventListener("click", (e) => {
  if(gifPanel.style.display !== "block") return;
  if(e.target.closest("#gifPanel")) return;
  if(e.target.closest("#gifBtn")) return;
  closeGif();
});

/* ===================== Start initial match ===================== */
(async () => {
  addBubble("Waking serverâ€¦ (free hosting). First match may take a bit.", "system");
  await startNewMatch();
})();
</script>
</body>
</html>
